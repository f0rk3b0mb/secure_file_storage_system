<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" type="text/css" href="/static/css/admin.css" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body bgcolor="cyan">
<div class="top_bar">
<h3><center>Welcome, {{ username }}</h1></center></h3>
<link_bar>
<button1><a href="/dashboard">dashboard</a></button1>
<button1><a href="/upload">upload files</a></button1>
<button1><a href="/logout">logout</a></button1>
<button1><a href="/register">register</a></button1>
<button1><a href="/users">users</a></button1>
<button1><a href="/files">files</a></button1>
<button1><a href="/backup">backup</a></button1>
</link_bar>
</div>

<h5><u>Pending User Approvals</u></h5>
<table border="1">
    <thead>
        <tr>
            <th>Username</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="pendingUserApprovals">
    </tbody>
</table>

<h5><u>Pending File Deletion</u></h5>
<table border="1">
    <thead>
        <tr>
            <th>File Name</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="pendingFileDeletionApprovals">
    </tbody>
</table>

<script>
  // Function to fetch and display pending user approvals
  function displayPendingUserApprovals() {
      fetch('/api/pending_users')
          .then(response => response.json())
          .then(data => {
              const pendingUserApprovals = document.getElementById('pendingUserApprovals');
              pendingUserApprovals.innerHTML = ''; // Clear the existing content

              if (data.length === 0) {
                  const row = pendingUserApprovals.insertRow(0);
                  const cell = row.insertCell(0);
                  cell.colSpan = 2;
                  cell.textContent = 'No pending user approvals.';
              } else {
                  data.forEach(user => {
                      const row = pendingUserApprovals.insertRow(pendingUserApprovals.rows.length);
                      const usernameCell = row.insertCell(0);
                      usernameCell.textContent = user.username;
                      const actionCell = row.insertCell(1);
                      const approveButton = document.createElement('button');
                      approveButton.textContent = 'Approve';
                      approveButton.addEventListener('click', () => approveUser(user.id));
                      actionCell.appendChild(approveButton);
                  });
              }
          });
  }

  // Function to send an approval request for a user
  function approveUser(userId) {
      // Send a POST request to approve the user
      fetch(`/api/approve_user/${userId}`, { method: 'POST' })
          .then(response => {
              if (response.status === 200) {
                  // Display updated list of pending user approvals
                  displayPendingUserApprovals();
                  // Optionally, you can update the UI to indicate that the user has been approved
                  alert('User approved successfully');
              } else {
                  alert('Failed to approve user');
              }
          });
  }

  // Function to fetch and display pending file deletion approvals
  function displayPendingFileDeletionApprovals() {
      fetch('/api/pending_deletion_requests')
          .then(response => response.json())
          .then(data => {
              const pendingFileDeletionApprovals = document.getElementById('pendingFileDeletionApprovals');
              pendingFileDeletionApprovals.innerHTML = ''; // Clear the existing content

              if (data.length === 0) {
                  const row = pendingFileDeletionApprovals.insertRow(0);
                  const cell = row.insertCell(0);
                  cell.colSpan = 2;
                  cell.textContent = 'No pending file deletion approvals.';
              } else {
                  data.forEach(file => {
                      const row = pendingFileDeletionApprovals.insertRow(pendingFileDeletionApprovals.rows.length);
                      const fileNameCell = row.insertCell(0);
                      fileNameCell.textContent = file.file_name;
                      const actionCell = row.insertCell(1);
                      const approveButton = document.createElement('button');
                      approveButton.textContent = 'Approve';
                      approveButton.addEventListener('click', () => approveDeletion(file.file_name));
                      actionCell.appendChild(approveButton);
                  });
              }
          });
  }

  // Function to send an approval request for file deletion
  function approveDeletion(fileName) {
      // Send a POST request to approve file deletion
      fetch(`/api/approve_deletion/${fileName}`, { method: 'POST' })
          .then(response => {
              if (response.status === 200) {
                  // Display updated list of pending file deletion approvals
                  displayPendingFileDeletionApprovals();
                  // Optionally, you can update the UI to indicate that the deletion request has been approved
                  alert('Deletion request approved successfully');
              } else {
                  alert('Failed to approve deletion request');
              }
          });
  }

  // Initial display of pending approvals
  displayPendingUserApprovals();
  displayPendingFileDeletionApprovals();
</script>

</body>
</html>
