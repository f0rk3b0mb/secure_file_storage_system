<!DOCTYPE html>
<html>
  <head>
    <title>Dashboard</title>
    <link rel="stylesheet" type="text/css" href="/static/css/dashboard.css" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body bgcolor="cyan">
    <div class="top_bar">
      <h3>Welcome, {{username}}</h3>
      <link_bar
        ><button1><a href="/upload">upload files</a></button1
        ><button1><a href="/logout">logout</a></button1></link_bar
      >
    </div>
    <h5>Your uploaded files:</h5>
    <ul id="fileList"></ul>
    <script>
      // Function to create a list item with both a link and a request button
      function addFileListItem(fileName) {
        const fileList = document.getElementById("fileList");
        const listItem = document.createElement("li");

        // Create a link for downloading
        const fileLink = document.createElement("a");
        fileLink.href = `/api/download/${fileName}`;
        fileLink.textContent = fileName;

        // Create a request button
        const requestButton = document.createElement("button");
        requestButton.textContent = "Request Deletion";
        requestButton.addEventListener("click", () => requestDelete(fileName));

        // Append the link and request button to the list item
        listItem.appendChild(fileLink);
        listItem.appendChild(requestButton);

        // Append the list item to the list
        fileList.appendChild(listItem);
      }

      // Fetch the list of files and create list items with links and request buttons
      function fetchFileList() {
        fetch("api/viewFiles")
          .then((response) => response.json())
          .then((data) => {
            const fileList = document.getElementById("fileList");
            fileList.innerHTML = ""; // Clear the list

            data.forEach((fileName) => {
              addFileListItem(fileName);
            });
          });
      }

      // Send a request for file deletion
      function requestDelete(fileName) {
        fetch("/api/deleteFiles", {
          method: "POST",
          body: new URLSearchParams({ file_name: fileName }),
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
        })
          .then((response) => {
            if (response.ok) {
              alert(
                "Your deletion request has been sent to the admin for approval."
              );
            } else {
              console.error("Failed to send deletion request");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      // Initial fetch of the file list when the page loads
      fetchFileList();
    </script>
  </body>
</html>
